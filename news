<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance Dashboard ‚Äî Indices & News</title>
  <style>
    :root{
      --bg:#f4f4f4; --text:#111; --card:#fff; --accent:#2e7d32;
    }
    body.dark-mode{ --bg:#121212; --text:#eee; --card:#1e1e1e; --accent:#0f5c25; }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); transition:.2s; }
    .navbar{ background:var(--accent); color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
    .brand{ font-weight:700; font-size:18px; }
    .controls{ display:flex; gap:8px; align-items:center; }
    .btn{ padding:6px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .toggle{ background:#fff; color:#000; }
    body.dark-mode .toggle{ background:#333; color:#fff; }
    .container{ max-width:1100px; margin:18px auto; padding:12px; }
    .top-row{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .select{ padding:8px 10px; border-radius:8px; border:1px solid #ccc; background:transparent; }
    .layout{ display:grid; grid-template-columns: 1fr 380px; gap:18px; }
    @media(max-width:1024px){ .layout{ grid-template-columns:1fr; } .right-column{ order:2; } }

    /* Index widgets */
    .widget{ background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:12px; }
    .widget h3{ margin:0 0 8px 0; font-size:18px; }
    .index-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:rgba(0,0,0,0.02); margin-bottom:8px; }
    body.dark-mode .index-row{ background:rgba(255,255,255,0.03); }
    .index-name{ font-weight:700; font-size:15px; }
    .index-value{ font-weight:800; font-size:18px; }
    .index-change{ font-weight:700; font-size:13px; margin-top:4px; }
    .updated{ text-align:right; color:gray; font-size:12px; margin-top:8px; }

    /* News */
    .news-card{ background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.08); transition:transform .15s; cursor:pointer; margin-bottom:12px; }
    .news-card:hover{ transform:translateY(-4px); }
    .news-card img{ width:100%; height:250px; object-fit:cover; display:block; }
    .news-body{ padding:17px; }
    .news-title{ font-size:16px; font-weight:700; margin-bottom:6px; color:var(--text); }
    .news-desc{ font-size:13px; color:gray; }
    body.dark-mode .news-desc{ color:#bbb; }

    .filters{ display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .filter-btn{ padding:8px 12px; border-radius:999px; border:1px solid #ccc; cursor:pointer; background:transparent; }
    .filter-btn.active{ background:var(--accent); color:#fff; border-color:transparent; }

    .loader{ text-align:center; padding:30px 0; color:gray; }
    .empty{ text-align:center; padding:30px 0; font-weight:700; }

    footer{ text-align:center; padding:18px 8px; color:gray; font-size:13px; margin-top:18px; }
    .warn{ color:#b00020; font-weight:700; margin-top:8px; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">Finance Dashboard</div>
    <div class="controls">
      <button id="manualRefresh" class="btn">‚ü≥ Refresh</button>
      <button id="darkToggle" class="btn toggle">üåô Dark Mode</button>
    </div>
  </div>

  <div class="container">
    <div class="top-row">
      <div>
        <label for="marketSelect" style="font-size:13px;color:gray">Select Market</label><br/>
        <select id="marketSelect" class="select">
          <option value="all">All</option>
          <option value="indian">Indian</option>
          <option value="international">International</option>
        </select>
      </div>

      
    </div>

    <div class="layout">
      <!-- left: news -->
      <div class="left-column">
        <div style="margin-bottom:10px;" class="filters" id="filters">
          <button class="filter-btn active" data-q="finance">All</button>
          <button class="filter-btn" data-q="crypto OR cryptocurrency">Crypto</button>
          <button class="filter-btn" data-q="stocks OR stock market">Stocks</button>
          <button class="filter-btn" data-q="banks OR banking">Banks</button>
        </div>

        <div id="newsContainer"></div>
      </div>

      <!-- right: indices -->
      <div class="right-column">
        <div class="widget">
          <h3>Indices</h3>
          <div id="indicesList"></div>
          <div class="updated" id="indicesUpdated">Updated: -</div>
        </div>

        <div id="warning" class="warn" style="display:none;"></div>
      </div>
    </div>

    <footer>
      News via NewsAPI (proxied). Indices via Twelve Data. Hard-coded Twelve Data API key is used in this page script as you requested.
    </footer>
  </div>

<script>
/* ------------------ CONFIG ------------------ */
/* Hard-coded Twelve Data API key (as requested) */
const TWELVE_DATA_API_KEY = "9df1ffb892d74d2689e56eee1d8ac606";

/* NewsAPI key (you already had one). If you want to change, update here */
const NEWS_API_KEY = "92da9144d32d418fa39004f2865b808a";

/* Auto refresh interval: 10 minutes */
const REFRESH_INTERVAL_MS = 10 * 60 * 1000;

/* Indices lists */
const INDIAN_INDICES = [
  { id: 'NIFTY_50', display: 'NIFTY 50', symbol: 'NSE/NIFTY_50' },
  { id: 'NIFTY_BANK', display: 'NIFTY Bank', symbol: 'NSE/NIFTY_BANK' },
  { id: 'SENSEX', display: 'Sensex (BSE)', symbol: 'BSE/SENSEX' }
];

const INTERNATIONAL_INDICES = [
  { id: 'SP500', display: 'S&P 500', symbol: 'SPX' },
  { id: 'NASDAQ', display: 'NASDAQ', symbol: 'NDX' },
  { id: 'DOW', display: 'Dow Jones', symbol: 'DJI' },
  { id: 'FTSE', display: 'FTSE 100', symbol: 'FTSE' },
  { id: 'NIKKEI', display: 'Nikkei 225', symbol: 'NIKKEI' }
];

/* Twelve Data base endpoint */
const TWELVE_BASE = 'https://api.twelvedata.com/quote';

/* News API base and proxied URL builder */
const NEWS_BASE = 'https://newsapi.org/v2/everything';
function buildNewsProxyUrl(q, pageSize = 30) {
  const params = new URLSearchParams({
    q,
    language: 'en',
    sortBy: 'publishedAt',
    pageSize: String(pageSize),
    apiKey: NEWS_API_KEY
  });
  const original = `${NEWS_BASE}?${params.toString()}`;
  return `https://api.allorigins.win/raw?url=${encodeURIComponent(original)}`;
}

/* Backoff & rate-limit handling */
let backoffActive = false;
let consecutiveErrors = 0;
const MAX_ERRORS_BEFORE_BACKOFF = 3;
const BACKOFF_INTERVAL_MS = 60 * 1000; // degrade to 60s if rate-limited

/* State */
let indicesTimer = null;
let newsTimer = null;

/* DOM refs */
const indicesListEl = document.getElementById('indicesList');
const indicesUpdatedEl = document.getElementById('indicesUpdated');
const marketSelect = document.getElementById('marketSelect');
const filtersEl = document.getElementById('filters');
const newsContainer = document.getElementById('newsContainer');
const warningEl = document.getElementById('warning');
const manualRefreshBtn = document.getElementById('manualRefresh');
const darkToggle = document.getElementById('darkToggle');

/* UI init */
function makeIndexRow(idx){
  const row = document.createElement('div');
  row.className = 'index-row';
  row.id = 'idx-'+idx.id;
  row.innerHTML = `
    <div>
      <div class="index-name">${idx.display}</div>
    </div>
    <div style="text-align:right">
      <div class="index-value" id="val-${idx.id}">-</div>
      <div class="index-change" id="chg-${idx.id}"></div>
    </div>
  `;
  return row;
}

function initIndicesUI(){
  indicesListEl.innerHTML = '';
  const toShow = getSelectedIndices();
  toShow.forEach(idx => indicesListEl.appendChild(makeIndexRow(idx)));
}

/* Helper: which indices to show based on market select */
function getSelectedIndices(){
  const m = marketSelect.value;
  if(m === 'indian') return INDIAN_INDICES;
  if(m === 'international') return INTERNATIONAL_INDICES;
  // all
  return [...INDIAN_INDICES, ...INTERNATIONAL_INDICES];
}

/* Update index UI */
function safeNumber(n){
  if(n === null || n === undefined || isNaN(Number(n))) return '-';
  return Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
}
function updateIndexUI(id, value, changePct){
  const valEl = document.getElementById('val-'+id);
  const chgEl = document.getElementById('chg-'+id);
  if(valEl) valEl.textContent = safeNumber(value);
  if(chgEl){
    if(changePct === null || changePct === undefined || changePct === '-') {
      chgEl.textContent = '';
      chgEl.style.color = '';
    } else {
      const num = Number(changePct);
      chgEl.textContent = (num>=0?'+':'') + num.toFixed(2) + '%';
      chgEl.style.color = num>=0 ? '#1b7a2f' : '#b00020';
    }
  }
}

/* Fetch indices via Twelve Data batch quote if possible */
async function fetchIndicesOnce(){
  warningEl.style.display = 'none';
  const toFetch = getSelectedIndices();
  if(toFetch.length === 0){
    indicesListEl.innerHTML = '';
    indicesUpdatedEl.textContent = 'Updated: -';
    return;
  }

  // if no key provided (but you provided key hard-coded), still check variable
  if(!TWELVE_DATA_API_KEY){
    // show mocks
    toFetch.forEach((idx,i)=>{
      updateIndexUI(idx.id, 1000 + Math.random()*1000, ((Math.random()*2)-1).toFixed(2));
    });
    const now = new Date();
    indicesUpdatedEl.textContent = 'Updated: ' + now.toLocaleTimeString();
    return;
  }

  // try batch fetch with comma-separated symbols
  const symbols = toFetch.map(t => t.symbol).join(',');
  const url = `${TWELVE_BASE}?symbol=${encodeURIComponent(symbols)}&apikey=${encodeURIComponent(TWELVE_DATA_API_KEY)}`;

  try {
    const res = await fetch(url);
    if(res.status === 429){
      throw new Error('rate_limit');
    }
    const j = await res.json();
    // Twelve Data returns either an object per symbol or a single object
    // Normalize: if single symbol requested returns object; if multiple returns object with keys per symbol
    // We'll try multiple ways to parse
    const map = {};
    if(Array.isArray(j)){
      j.forEach(item => { if(item && item.symbol) map[item.symbol] = item; });
    } else if(j && j.symbol){
      map[j.symbol] = j;
    } else if(j && typeof j === 'object'){
      // sometimes returns { "AAPL": {...}, "MSFT": {...} }
      Object.keys(j).forEach(k => {
        if(j[k] && typeof j[k] === 'object' && (j[k].price || j[k].close || j[k].symbol)) map[k] = j[k];
      });
    }

    // Map results to UI
    toFetch.forEach(idx => {
      // try keys: full symbol, short symbol (after slash), idx.id
      const key1 = idx.symbol;
      const key2 = idx.symbol.split('/').pop();
      const entry = map[key1] || map[key2] || map[idx.id] || map[idx.symbol];
      if(entry && entry.price){
        // prefer entry.price, else entry.close
        const price = Number(entry.price || entry.close || entry.previous_close || null);
        const pct = entry.percent_change ? Number(entry.percent_change) : (entry.percent_change_24h ? Number(entry.percent_change_24h) : null);
        updateIndexUI(idx.id, price, pct);
      } else {
        updateIndexUI(idx.id, '-', '-');
      }
    });

    // reset error counter
    consecutiveErrors = 0;
    indicesUpdatedEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
  } catch(err){
    console.warn('Twelve Data batch fetch failed:', err);
    consecutiveErrors++;
    // If rate-limited or repeated errors -> enable backoff and show warning
    if((err.message && err.message.toLowerCase().includes('rate')) || consecutiveErrors >= MAX_ERRORS_BEFORE_BACKOFF){
      backoffActive = true;
      warningEl.style.display = 'block';
      warningEl.textContent = 'Rate limit or repeated errors detected ‚Äî auto-refresh slowed to avoid blocking.';
      resetIndicesPolling(true);
      return;
    }

    // fallback: try sequential per-symbol calls (less bursty)
    try {
      for(const idx of toFetch){
        try {
          const singleUrl = `${TWELVE_BASE}?symbol=${encodeURIComponent(idx.symbol)}&apikey=${encodeURIComponent(TWELVE_DATA_API_KEY)}`;
          const r = await fetch(singleUrl);
          if(r.status === 429) throw new Error('rate_limit');
          const obj = await r.json();
          if(obj && obj.price){
            const price = Number(obj.price);
            const pct = obj.percent_change ? Number(obj.percent_change) : (obj.percent_change_24h ? Number(obj.percent_change_24h) : null);
            updateIndexUI(idx.id, price, pct);
          } else {
            updateIndexUI(idx.id, '-', '-');
          }
        } catch(e){
          console.warn('single fetch error for', idx.symbol, e);
          updateIndexUI(idx.id, '-', '-');
        }
        await new Promise(res => setTimeout(res, 250)); // small gap between calls
      }
      indicesUpdatedEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
    } catch(e2){
      console.error('Sequential fallback failed', e2);
      warningEl.style.display = 'block';
      warningEl.textContent = 'Failed to fetch live indices. Showing placeholders. Check API key or provider limits.';
    }
  }
}

/* News fetch & render (keeps previous features) */
function buildNewsQuery() {
  // find active filter
  const activeBtn = document.querySelector('.filter-btn.active');
  const q = activeBtn ? activeBtn.dataset.q : 'finance';
  return q;
}

async function fetchNewsOnce(){
  newsContainer.innerHTML = `<div class="loader">Loading news...</div>`;
  try {
    const q = buildNewsQuery() || 'finance';
    const url = buildNewsProxyUrl(q);
    const res = await fetch(url);
    const j = await res.json();
    if(!j || !j.articles || j.articles.length === 0){
      newsContainer.innerHTML = `<div class="empty">No finance news available.</div>`;
      return;
    }
    renderNews(j.articles);
  } catch(e){
    console.error('News fetch error', e);
    newsContainer.innerHTML = `<div class="empty">Failed to load news. Try Refresh.</div>`;
  }
}

function renderNews(articles){
  const frag = document.createDocumentFragment();
  articles.forEach(article => {
    const card = document.createElement('div');
    card.className = 'news-card';
    card.onclick = () => { if(article.url) window.open(article.url, '_blank'); };

    const media = article.urlToImage ? `<img src="${article.urlToImage}" alt="image">`
      : `<div style="height:180px;background:#ddd;display:flex;align-items:center;justify-content:center;color:#888">No Image</div>`;

    const title = `<div class="news-title">${escapeHtml(article.title || 'No title')}</div>`;
    const desc  = `<div class="news-desc">${escapeHtml(article.description || '')}</div>`;
    const body  = `<div class="news-body">${title}${desc}</div>`;

    card.innerHTML = media + body;
    frag.appendChild(card);
  });
  newsContainer.innerHTML = '';
  newsContainer.appendChild(frag);
}

/* Helpers */
function escapeHtml(text){
  if(!text) return '';
  return text.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* Polling control */
function startIndicesPolling(){
  stopIndicesPolling();
  const interval = backoffActive ? BACKOFF_INTERVAL_MS : REFRESH_INTERVAL_MS;
  // run immediately
  fetchIndicesOnce();
  indicesTimer = setInterval(fetchIndicesOnce, interval);
}

function stopIndicesPolling(){
  if(indicesTimer) clearInterval(indicesTimer);
  indicesTimer = null;
}

function resetIndicesPolling(setBackoff=false){
  if(setBackoff) backoffActive = true;
  stopIndicesPolling();
  // run once immediately and schedule
  fetchIndicesOnce();
  startIndicesPolling();
}

/* News polling */
function startNewsPolling(){
  stopNewsPolling();
  fetchNewsOnce();
  newsTimer = setInterval(fetchNewsOnce, REFRESH_INTERVAL_MS);
}
function stopNewsPolling(){
  if(newsTimer) clearInterval(newsTimer);
  newsTimer = null;
}

/* Init UI & events */
function init(){
  // build indices UI for the default selection
  initIndicesUI();

  // filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      fetchNewsOnce();
    });
  });

  // market dropdown immediate filter
  marketSelect.addEventListener('change', ()=>{
    initIndicesUI(); // rebuild list based on selection
    // fetch once for new selection immediately
    fetchIndicesOnce();
  });

  manualRefreshBtn.addEventListener('click', ()=>{
    fetchIndicesOnce();
    fetchNewsOnce();
  });

  darkToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('dark-mode');
    darkToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  });

  // start polling
  startIndicesPolling();
  startNewsPolling();
}

/* Start */
init();

</script>
</body>
</html>
